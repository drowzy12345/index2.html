          local dui
        local activeMenu = {}
        local activeIndex = 1



        -- ===================== ONLINE PLAYERS (GLOBAL) =====================

-- ===================== ONLINE PLAYERS =====================

function GetOnlinePlayers()
    local players = {}

    if GetActivePlayers == nil then
        return players
    end

    for _, player in ipairs(GetActivePlayers()) do
        local name = GetPlayerName(player)
        if name then
            table.insert(players, {
                label = name,
                id = player
            })
        end
    end

    return players
end



        -- ===================== MENU DATA =====================
        table.insert(activeMenu, {
            label = 'Self',
            type = 'submenu',
            icon = 'ph-user',
            submenu = {
                { 
                    label = 'Checkbox Test', 
                    type = 'checkbox', 
                    onConfirm = function(setToggle) end 
                },
                { 
                    label = 'Scroll Test', 
                    type = 'scroll', 
                    selected = 2, 
                    options = { 'test', 'test2', 'test3' }, 
                    onConfirm = function(option) end 
                },
                { 
                    label = 'Slider Test', 
                    type = 'slider', 
                    min = 0, 
                    max = 100, 
                    value = 50, 
                    onConfirm = function(val) end 
                },
                { 
                    label = 'Revive', 
                    type = 'button',
                    onConfirm = function()
                        if GetResourceState("wasabi_ambulance") == 'started' then
                            MachoInjectResource2(3, 'wasabi_ambulance', [[
                        TriggerEvent('wasabi_ambulance:revive')
                            ]])
                        elseif GetResourceState("ak47_ambulancejob") == 'started' then
                            MachoInjectResource2(3, 'ak47_ambulancejob', [[
                        TriggerEvent('ak47_ambulancejob:revive')
                            ]])
                        else
                            print("No Revive Script Found")
                        end
                    end
                },
                {
    label = 'Model',
    type = 'submenu',
    icon = 'ph-money',
    getSubMenu = function(callback)
        local setOptions = {
            {
    label = 'Model',
    type = 'submenu',
    icon = 'ph-money',
    getSubMenu = function(callback)
        local setOptions = {
            {
                label = 'Apearance',
                type = 'submenu',
                icon = 'ph-list',
                getSubMenu = function(subCallback)
                    local subOptions = {
                        {
                            label = 'KKK Outfit',
                            type = 'button',
                            onConfirm = function()
                                local ped = PlayerPedId()
                                SetPedComponentVariation(ped, 11, 109, 0, 2)
                                SetPedComponentVariation(ped, 8, 15, 0, 2)
                                SetPedComponentVariation(ped, 3, 5, 0, 2)
                                SetPedComponentVariation(ped, 4, 56, 0, 2)
                                SetPedComponentVariation(ped, 6, 19, 0, 2)
                                SetPedPropIndex(ped, 0, 1, 0, true)
                            end
                        },
                        {
                            label = 'Complete Random Outfit',
                            type = 'button',
                            onConfirm = function()
                                local ped = PlayerPedId()
                                -- Define a fixed outfit with randomized, but consistent, matching components per slot
                                -- You can expand these ranges to whatever is appropriate for your models
                                local outfit = {
                                    [3] = {ids = {0,1,2,5,10}, textures = {0,1}}, -- arms
                                    [4] = {ids = {10,21,39,42,45,56}, textures = {0,1}},
                                    [6] = {ids = {1,3,6,10,11,17,19}, textures = {0,1}},
                                    [8] = {ids = {0,1,8,15,30,52}, textures = {0,1}},
                                    [11] = {ids = {0,10,11,23,45,57,109}, textures = {0,1}}
                                }
                                for comp, v in pairs(outfit) do
                                    local drawable = v.ids[math.random(#v.ids)]
                                    local texture = v.textures[math.random(#v.textures)]
                                    SetPedComponentVariation(ped, comp, drawable, texture, 2)
                                end
                                -- Random but valid props (leave some slots empty)
                                local propIndices = {
                                    [0] = {ids = {1, 2, 7}, textures = {0, 1}},
                                    [1] = {ids = {0, 1, 2}, textures = {0, 1}},
                                    [2] = {ids = {0, 6}, textures = {0, 1}},
                                    [6] = {ids = {0, 1}, textures = {0, 1}},
                                    [7] = {ids = {0}, textures = {0}}
                                }
                                for i = 0, 7 do
                                    local propInfo = propIndices[i]
                                    if propInfo and math.random() > 0.3 then -- 70% chance to wear this prop
                                        local propDrawable = propInfo.ids[math.random(#propInfo.ids)]
                                        local propTexture = propInfo.textures[math.random(#propInfo.textures)]
                                        SetPedPropIndex(ped, i, propDrawable, propTexture, true)
                                    else
                                        ClearPedProp(ped, i)
                                    end
                                end
                            end
                        },
                        {
                            label = 'Sub Option 2',
                            type = 'button',
                            onConfirm = function() end
                        }
                    }
                    subCallback(subOptions)
                end
            },
            {
                label = 'Sub Option 2',
                type = 'button',
                onConfirm = function() end
            }
        }
        callback(setOptions)
    end
},
                {
                    label = 'Change Model',
                    type = 'submenu',
                    icon = 'ph-user',
                    getSubMenu = function(subCallback)
                        local subOptions = {
                            {
                                label = 'Freemode Male',
                                type = 'button',
                                onConfirm = function()
                                    local model = GetHashKey("mp_m_freemode_01")
                                    RequestModel(model)
                                    while not HasModelLoaded(model) do
                                        Wait(0)
                                    end
                                    SetPlayerModel(PlayerId(), model)
                                    SetModelAsNoLongerNeeded(model)
                                end
                            },
                            {
                                label = 'Freemode Female',
                                type = 'button',
                                onConfirm = function()
                                    local model = GetHashKey("mp_f_freemode_01")
                                    RequestModel(model)
                                    while not HasModelLoaded(model) do
                                        Wait(0)
                                    end
                                    SetPlayerModel(PlayerId(), model)
                                    SetModelAsNoLongerNeeded(model)
                                end
                            }
                        }
                        subCallback(subOptions)
                    end
                },
                {
                    label = 'Accessories',
                    type = 'submenu',
                    icon = 'ph-briefcase',
                    getSubMenu = function(subCallback)
                        local subOptions = {
                            {
                                label = 'Remove Hat',
                                type = 'button',
                                onConfirm = function()
                                    ClearPedProp(PlayerPedId(), 0)
                                end
                            },
                            {
                                label = 'Add Glasses',
                                type = 'button',
                                onConfirm = function()
                                    SetPedPropIndex(PlayerPedId(), 1, 5, 0, true)
                                end
                            }
                        }
                        subCallback(subOptions)
                    end
                }
            }
            callback(setOptions)
        end
    },
                {


                    label = 'Toggle Freecam',
                    type = 'checkbox',
                    checked = false,
                    onConfirm = function(toggled)
                        cam_active = toggled
                        toggle_camera()
                    end



                },
                {
                label = 'GodMode',
                type = 'checkbox',
                checked = false,
                onConfirm = function(toggled)
                    godModeEnabled = toggled
                
                    local ped = PlayerPedId()

                    if toggled then
                        
                        SetPlayerInvincible(PlayerId(), true)
                    else
                        
                        SetPlayerInvincible(PlayerId(), false)
                        SetEntityCanBeDamaged(ped, true)
                    end
                end
                },
                {

                    label = 'Invisible',
                    type = 'checkbox',
                    checked = false,
                    onConfirm = function(toggled)
                    local ped = PlayerPedId()
                if toggled then
                    SetEntityVisible(ped, false, false)
                else
                    SetEntityVisible(ped, true, false)
                        end
                    end
                },
                { 
                    label = 'Toggle Noclip',
                    type = 'checkbox',
                    checked = false,
                    onConfirm = function(toggled)
                        noclip = toggled
                    end
                },
                {
    label = 'Infinite Punch',
    type = 'button',
    onConfirm = function()
        
                            ClearPedTasksImmediately(PlayerPedId())
                            
    end
}
            }
        })


table.insert(activeMenu, {
    label = 'Server',
    type = 'submenu',
    icon = 'ph-server',
    submenu = {

        {
            label = 'Players',
            type = 'submenu',
            icon = 'ph-users',
            submenu = {

                -- ================= ONLINE PLAYERS =================
                {
                    label = 'Online Players',
                    type = 'submenu',
                    icon = 'ph-list',
                    getSubMenu = function(callback)
                        local menu = {}

                        if GetOnlinePlayers and type(GetOnlinePlayers) == "function" then
                            local players = GetOnlinePlayers()

                            if #players == 0 then
                                table.insert(menu, {
                                    label = '(no players)',
                                    type = 'button',
                                    onConfirm = function() end
                                })
                            else
                                for _, ply in ipairs(players) do
                                    table.insert(menu, {
                                        label = string.format('%s [ id %s ]', ply.label, tostring(ply.id)),
                                        type = 'checkbox',
                                        checked = (SelectedPlayerId == ply.id),
                                        onConfirm = function(state)
                                            if state then
                                                SelectedPlayerId = ply.id
                                            elseif SelectedPlayerId == ply.id then
                                                SelectedPlayerId = nil
                                            end
                                        end
                                    })
                                end
                            end
                        end

                        callback(menu)
                    end
                },

                -- ================= PLAYER MENU =================
                {
                    label = 'Player',
                    type = 'submenu',
                    icon = 'ph-user',
                    submenu = {
                        {
                            label = 'Teleport To Player',
                            type = 'button',
                            onConfirm = function()
                                if SelectedPlayerId then
                                    local targetPed = GetPlayerPed(SelectedPlayerId)
                                    if targetPed and DoesEntityExist(targetPed) then
                                        local coords = GetEntityCoords(targetPed)
                                        -- Assuming you want to teleport the local player/ped
                                        local playerPed = PlayerPedId and PlayerPedId() or GetPlayerPed(-1)
                                        if playerPed and DoesEntityExist(playerPed) then
                                            SetEntityCoords(playerPed, coords.x, coords.y, coords.z, false, false, false, false)
                                        end
                                    end
                                end
                            end
                        },
                        {
                            label = 'Copy Player Outfit',
                            type = 'button',
                            onConfirm = function()
                                if not SelectedPlayerId then return end

                                local targetPed = GetPlayerPed(SelectedPlayerId)
                                if not DoesEntityExist(targetPed) then return end

                                local playerPed = PlayerPedId and PlayerPedId() or GetPlayerPed(-1)
                                if not DoesEntityExist(playerPed) then return end

                                -- Copy all clothing components (0-11)
                                for component = 0, 11 do
                                    local drawable = GetPedDrawableVariation(targetPed, component)
                                    local texture = GetPedTextureVariation(targetPed, component)
                                    local palette = GetPedPaletteVariation(targetPed, component)
                                    SetPedComponentVariation(playerPed, component, drawable, texture, palette)
                                end

                                -- Copy all props (0-7)
                                for prop = 0, 7 do
                                    local propIndex = GetPedPropIndex(targetPed, prop)
                                    if propIndex ~= -1 then
                                        local propTexture = GetPedPropTextureIndex(targetPed, prop)
                                        SetPedPropIndex(playerPed, prop, propIndex, propTexture, true)
                                    else
                                        ClearPedProp(playerPed, prop)
                                    end
                                end
                            end
                        },
                        {
                            label = 'Spectate Player',
                            type = 'checkbox',
                            checked = function()
                                return IsSpectatingPlayer == true
                            end,
                            onConfirm = function(state)
                                if state then
                                    if SelectedPlayerId then
                                        local targetPed = GetPlayerPed(SelectedPlayerId)
                                        if targetPed and DoesEntityExist(targetPed) then
                                            NetworkSetInSpectatorMode(true, targetPed)
                                            IsSpectatingPlayer = true
                                        end
                                    end
                                else
                                    NetworkSetInSpectatorMode(false, 0)
                                    IsSpectatingPlayer = false
                                end
                            end
                        },
                    }
                },

                -- ================= TROLL MENU =================
                {
                    label = 'Troll',
                    type = 'submenu',
                    icon = 'ph-skull',
                    submenu = {
                        {
                            label = 'Explode Player',
                            type = 'button',
                            onConfirm = function()
                                if not SelectedPlayerId then return end

                                local ped = GetPlayerPed(SelectedPlayerId)
                                if DoesEntityExist(ped) then
                                    local coords = GetEntityCoords(ped)
                                    AddExplosion(coords.x, coords.y, coords.z, 4, 1.0, true, false, 1.0)
                                end
                            end
                        },
                        {
                            label = 'Set Player On Fire',
                            type = 'button',
                            onConfirm = function()
                                if not SelectedPlayerId then return end

                                local ped = GetPlayerPed(SelectedPlayerId)
                                if DoesEntityExist(ped) then
                                    StartEntityFire(ped)
                                end
                            end
                        },
                        -- CLONE AND ATTACK
                        {
                            label = 'Clone & Attack Player',
                            type = 'button',
                            onConfirm = function()
                                if not SelectedPlayerId then return end

                                local targetPed = GetPlayerPed(SelectedPlayerId)
                                if not DoesEntityExist(targetPed) then return end

                                -- Clone the player ped
                                local targetModel = GetEntityModel(targetPed)
                                RequestModel(targetModel)
                                while not HasModelLoaded(targetModel) do
                                    Wait(0)
                                end

                                local coords = GetEntityCoords(targetPed)
                                local heading = GetEntityHeading(targetPed)

                                -- Spawn clone slightly behind the player
                                local distance = 2.0
                                local backRad = math.rad(heading + 180.0)
                                local spawnX = coords.x + math.cos(backRad) * distance
                                local spawnY = coords.y + math.sin(backRad) * distance
                                local spawnZ = coords.z

                                local clonePed = CreatePed(4, targetModel, spawnX, spawnY, spawnZ, heading, true, true)
                                if not DoesEntityExist(clonePed) then
                                    SetModelAsNoLongerNeeded(targetModel)
                                    return
                                end

                                SetModelAsNoLongerNeeded(targetModel)
                                SetEntityAsMissionEntity(clonePed, true, true)
                                SetPedFleeAttributes(clonePed, 0, false)
                                SetPedCombatAttributes(clonePed, 46, true)  -- AlwaysFight
                                SetPedCombatAttributes(clonePed, 0, true)   -- Aggressive
                                SetPedCombatAbility(clonePed, 2)
                                SetPedAsEnemy(clonePed, true)
                                GiveWeaponToPed(clonePed, GetHashKey("WEAPON_BAT"), 1, false, true)
                                -- optionally god mode the clone to be more trolly
                                -- SetEntityInvincible(clonePed, true)

                                -- Tell the clone to attack the player
                                TaskCombatPed(clonePed, targetPed, 0, 16)
                            end
                        },
                        {
                            label = 'Ram Player (Sultan)',
                            type = 'button',
                            onConfirm = function()
                                if not SelectedPlayerId then return end

                                local targetPed = GetPlayerPed(SelectedPlayerId)
                                if not DoesEntityExist(targetPed) then return end

                                local targetCoords = GetEntityCoords(targetPed)
                                local heading = GetEntityHeading(targetPed)

                                -- ================= SPAWN BEHIND PLAYER =================
                                local distance = 12.0
                                local rad = math.rad(heading)

                                local forwardX = math.sin(rad)
                                local forwardY = -math.cos(rad)

                                local spawnX = targetCoords.x - forwardX * distance
                                local spawnY = targetCoords.y - forwardY * distance
                                local spawnZ = targetCoords.z + 0.5

                                -- Face toward player
                                local vehicleHeading = (heading + 180.0) % 360.0

                                -- ================= LOAD MODEL =================
                                local model = GetHashKey("sultan")
                                RequestModel(model)
                                while not HasModelLoaded(model) do Wait(0) end

                                local veh = CreateVehicle(
                                    model,
                                    spawnX, spawnY, spawnZ,
                                    vehicleHeading,
                                    true,
                                    false
                                )

                                if not DoesEntityExist(veh) then
                                    SetModelAsNoLongerNeeded(model)
                                    return
                                end

                                SetEntityAsMissionEntity(veh, true, true)
                                SetVehicleOnGroundProperly(veh)
                                SetVehicleEngineOn(veh, true, true, false)
                                SetEntityHeading(veh, vehicleHeading)

                                -- ================= FORCE RAM (NO DRIVER) =================
                                Citizen.CreateThread(function()
                                    local force = 70.0

                                    while DoesEntityExist(veh) and DoesEntityExist(targetPed) do
                                        local vCoords = GetEntityCoords(veh)
                                        local tCoords = GetEntityCoords(targetPed)

                                        local dx = tCoords.x - vCoords.x
                                        local dy = tCoords.y - vCoords.y

                                        local mag = math.sqrt(dx * dx + dy * dy)
                                        if mag < 0.8 then
                                            break
                                        end

                                        dx = dx / mag
                                        dy = dy / mag

                                        SetEntityVelocity(
                                            veh,
                                            dx * force,
                                            dy * force,
                                            0.0
                                        )

                                        Wait(0)
                                    end
                                end)

                                SetModelAsNoLongerNeeded(model)
                            end
                        }
                    }
                },

                -- ================= VEHICLE MENU =================
                {
                    label = 'Vehicle',
                    type = 'submenu',
                    icon = 'ph-car',
                    submenu = {
                        {
                            label = "Teleport Into Player's Vehicle",
                            type = "button",
                            onConfirm = function()
                                if not SelectedPlayerId then return end
                                local targetPed = GetPlayerPed(SelectedPlayerId)
                                if not DoesEntityExist(targetPed) then return end

                                -- Try to find the vehicle the player is in (current or last), making sure it's a valid vehicle
                                local targetVeh = GetVehiclePedIsIn(targetPed, false)
                                if not targetVeh or targetVeh == 0 or not DoesEntityExist(targetVeh) then
                                    targetVeh = GetVehiclePedIsIn(targetPed, true)
                                end
                                if not targetVeh or targetVeh == 0 or not DoesEntityExist(targetVeh) then
                                    -- couldn't find a vehicle
                                    return
                                end

                                local playerPed = PlayerPedId and PlayerPedId() or GetPlayerPed(-1)
                                if not playerPed or not DoesEntityExist(playerPed) then return end

                                -- Try all seats, except those occupied
                                local foundSeat = nil
                                -- Seats are indexed from -1 (driver), then 0..(maxSeats-2)
                                local maxSeats = GetVehicleMaxNumberOfPassengers(targetVeh)
                                -- Prefer passenger seats, only use driver if all else fails
                                -- Try all seats from 0..maxSeats-1 first, then driver (-1) last.
                                for seat = 0, maxSeats - 1 do
                                    if IsVehicleSeatFree(targetVeh, seat) then
                                        foundSeat = seat
                                        break
                                    end
                                end
                                if foundSeat == nil and IsVehicleSeatFree(targetVeh, -1) then
                                    foundSeat = -1
                                end

                                if foundSeat ~= nil then
                                    -- Try to warp into found seat -- this should actually put you in the player's vehicle
                                    TaskWarpPedIntoVehicle(playerPed, targetVeh, foundSeat)
                                else
                                    -- If couldn't warp, just teleport beside the vehicle as a fallback
                                    local vehCoords = GetEntityCoords(targetVeh)
                                    -- Find a position near the door (use offset, e.g., 2.0 right of vehicle)
                                    local offX, offY, offZ = 2.0, 0.0, 0.0
                                    local fw = GetEntityForwardVector(targetVeh)
                                    local right = vector3(-fw.y, fw.x, 0.0)
                                    local teleX = vehCoords.x + right.x * offX
                                    local teleY = vehCoords.y + right.y * offX
                                    local teleZ = vehCoords.z + offZ
                                    SetEntityCoords(playerPed, teleX, teleY, teleZ, false, false, false, false)
                                end
                            end
                        },
                        -- Add other vehicle-related options here if needed
                    }
                },
            }
        }

    }
})








        table.insert(activeMenu, {
            label = 'Weapon',
            type = 'submenu',
            icon = 'ph-Weapon',
            submenu = {
                { 
                    label = 'Button Test',
                    type = 'button',
                    onConfirm = function()
                        
                    end
                }
            }
        })

table.insert(activeMenu, {
    label = 'Vehicle',
    type = 'submenu',
    icon = 'ph-Vehicle',
    submenu = {
        { 
            label = 'Button Test',
            type = 'button',
            onConfirm = function()
                -- DEBUG: Entry point
                
                local playerPed = PlayerPedId()
                if not playerPed or playerPed == -1 then
                    
                    return
                end

                local veh = GetVehiclePedIsIn(playerPed, false)
                if veh == nil or veh == 0 then
                    
                    return
                end

                

                -- Ensure mod kit can be set
                if SetVehicleModKit then
                    SetVehicleModKit(veh, 0)
                else
                    
                end

                -- Paint colors
                if SetVehicleCustomPrimaryColour then SetVehicleCustomPrimaryColour(veh, 0, 0, 0) end
                if SetVehicleCustomSecondaryColour then SetVehicleCustomSecondaryColour(veh, 0, 0, 0) end
                if SetVehicleColours then SetVehicleColours(veh, 12, 12) end
                if SetVehicleExtraColours then SetVehicleExtraColours(veh, 3, 0) end

                -- Mods and upgrades
                if ToggleVehicleMod then
                    ToggleVehicleMod(veh, 18, true) -- Turbo  
                    ToggleVehicleMod(veh, 22, true) -- Xenon Lights
                end
                if SetVehicleMod then
                    SetVehicleMod(veh, 16, 5, false) -- Suspension
                    SetVehicleMod(veh, 12, 2, false) -- Brakes
                    SetVehicleMod(veh, 11, 3, false) -- Engine
                    SetVehicleMod(veh, 14, 14, false) -- Horn
                    SetVehicleMod(veh, 15, 3, false) -- Transmission
                    SetVehicleMod(veh, 13, 2, false) -- Armor
                    SetVehicleMod(veh, 23, 21, true) -- Wheels
                    -- Apply mods for all other applicable slots
                    for i = 0, 10 do
                        SetVehicleMod(veh, i, 1, false)
                    end
                else
                    
                end

                if SetVehicleWindowTint then SetVehicleWindowTint(veh, 5) end
                if SetVehicleWheelType then SetVehicleWheelType(veh, 0) end

                -- Neon Lights and Tyre Smoke
                if SetVehicleNeonLightEnabled then
                    for i = 0, 3 do
                        SetVehicleNeonLightEnabled(veh, i, true)
                    end
                end

                local defaultColor = {r=255,g=0,b=255}
                local neonColor = (type(MainColor)=="table" and MainColor.r and MainColor.g and MainColor.b) and MainColor or defaultColor

                if SetVehicleNeonLightsColour then
                    SetVehicleNeonLightsColour(veh, neonColor.r, neonColor.g, neonColor.b)
                end
                if SetVehicleTyreSmokeColor then
                    SetVehicleTyreSmokeColor(veh, neonColor.r, neonColor.g, neonColor.b)
                end

                
            end
        },
        {
            label = 'Repair Vehicle',
            type = 'button',
            onConfirm = function()
                
                local playerPed = PlayerPedId()
                if not playerPed or playerPed == -1 then
                    
                    return
                end

                local veh = GetVehiclePedIsIn(playerPed, false)
                if veh == nil or veh == 0 then
                    
                    return
                end

                -- Attempt to repair vehicle using various natives
                if SetVehicleFixed then
                    SetVehicleFixed(veh)
                else
                    
                end

                if SetVehicleDeformationFixed then
                    SetVehicleDeformationFixed(veh)
                end

                if SetVehicleUndriveable then
                    SetVehicleUndriveable(veh, false)
                end

                if SetVehicleEngineHealth then
                    SetVehicleEngineHealth(veh, 1000.0)
                end

                if SetVehiclePetrolTankHealth then
                    SetVehiclePetrolTankHealth(veh, 1000.0)
                end

                if SetVehicleBodyHealth then
                    SetVehicleBodyHealth(veh, 1000.0)
                end

                if SetVehicleDirtLevel then
                    SetVehicleDirtLevel(veh, 0.0)
                end

                
            end
        }
    }
})

        table.insert(activeMenu, {
            label = 'Emotes',
            type = 'submenu',
            icon = 'ph-Emotes',
            submenu = {
                { 
                    label = 'Button Test',
                    type = 'button',
                    onConfirm = function()
                        
                    end
                }
            }
        })











        table.insert(activeMenu, {
            label = 'Teleports',
            type = 'submenu',
            icon = 'ph-Teleports',
            submenu = {
                { 
                    label = 'Button Test',
                    type = 'button',
                    onConfirm = function()
                        
                    end
                }
            }
        })


-- Function to show a text input
function GetUserInput(title, defaultText, maxLength)
    DisplayOnscreenKeyboard(1, "FMMC_KEY_TIP8", "", defaultText or "", "", "", "", maxLength or 100)
    while UpdateOnscreenKeyboard() == 0 do
        Citizen.Wait(0)
    end
    if GetOnscreenKeyboardResult() then
        return GetOnscreenKeyboardResult()
    end
    return nil
end

-- Fallback for RunAllActiveResourceActions, in case it isn't defined
local function RunAllActiveResourceActions(resourceActions)
    local ranAny = false
    -- attempt to get running resource name
    local resourceName = (GetResourceName and GetResourceName(GetCurrentResourceName())) or (GetCurrentResourceName and GetCurrentResourceName()) or nil
    -- if resourceName is nil, brute force try active resourceActions
    if resourceName then
        local action = resourceActions[resourceName]
        if action then
            action()
            ranAny = true
        end
    else
        -- fallback: try running ALL actions (should be safe in your menu context)
        for _, action in pairs(resourceActions) do
            if type(action) == "function" then
                action()
                ranAny = true
            end
        end
    end
    return ranAny
end

-- Usage in menu
local lastItemName = ""
local lastAmount = 1

table.insert(activeMenu, {
    label = 'Exploits',
    type = 'submenu',
    icon = 'ph-skull',
    submenu = {

        { 
            label = 'WaveSheild Bypass',
            type = 'button',
            onConfirm = function()
                if GetResourceState("WaveShield") == 'started' then
                    for i = 1, 2 do
                        MachoInjectResource2(3, 'WaveShield', [[
                            error('An unexpected error occurred.')
                        ]])
                    end
                else
                    print("WaveShield Not Found")
                end
            end
        },
        {
            label = 'FiveGuard Bypass',
            type = 'button',
            onConfirm = function()
                local found_any = false
                for i = 0, GetNumResources() - 1 do
                    local resource = GetResourceByFindIndex(i)
                    if resource and GetResourceState(resource) == "started" then
                        local files = GetNumResourceMetadata(resource, "client_script")
                        local foundFiveGuard = false
                        for j = 0, files - 1 do
                            local metadata = GetResourceMetadata(resource, "client_script", j)
                            if metadata and string.find(metadata, "obfuscated") then
                                print("^7[Extorted]: Detected FiveGuard in Resource: " .. resource)
                                foundFiveGuard = true
                                break
                            end
                        end
                        if foundFiveGuard then
                            MachoResourceStop(resource)
                            print("^7[Extorted]: Stopped Resource: " .. resource)
                            found_any = true
                            return resource
                        end
                    end
                end
                if not found_any then
                    print("FiveGuard Not Found")
                end
                return nil
            end
        },
        { 
            label = 'Reaper Bypass',
            type = 'button',
            onConfirm = function()
                if GetResourceState("ReaperV4") == 'started' then
                    print("ReaperV4 Disabler")
                    MachoInjectResource2(2, "ReaperV4", [[
                        pcall(function()
                            local name, eventHandlersRaw = debug.getupvalue(_G["RemoveEventHandler"], 2)
                            local eventHandlers = {}

                            for name, raw in pairs(eventHandlersRaw) do
                                if raw.handlers then
                                    for id, v in pairs(raw.handlers) do
                                        table.insert(eventHandlers,
                                            {
                                                handle = {
                                                    ['key'] = id,
                                                    ['name'] = name
                                                },
                                                func = v,
                                                type = (string.find(name, "__cfx_nui") and "NUICallback") or
                                                    (string.find(name, "__cfx_export") and "Export") or "Event"
                                            })
                                    end
                                end
                            end

                            local reaper_newdetection
                            for i, v in pairs(eventHandlers) do
                                local name = v["handle"]["name"];
                                local func = v["func"]

                                if name == "Reaper:NewDetection" then
                                    reaper_newdetection = func
                                end
                            end

                            if type(reaper_newdetection) ~= "function" then return print("error") end

                            local _, securityclient = debug.getupvalue(reaper_newdetection, 1);

                            for name, detection in pairs(securityclient["detections"]) do
                                if detection["detected"] then
                                    securityclient["detections"][name]["detected"] = function(...)
                                        local args = { ... }
                                        print(name, "detected", json.encode(args or {}))
                                        return
                                    end
                                end

                                if detection["callback"] then
                                    securityclient["detections"][name]["callback"] = function(...)
                                        local args = { ... }
                                        print(name, "callback", json.encode(args or {}))
                                        return
                                    end
                                end
                            end

                            for name, detection in pairs(securityclient["active_detections"]) do
                                if detection["detected"] then
                                    securityclient["active_detections"][name]["detected"] = function(...)
                                        return
                                    end
                                end

                                if detection["callback"] then
                                    securityclient["active_detections"][name]["callback"] = function(...)
                                        return
                                    end
                                end
                            end

                            Debug.setupvalue(reaper_newdetection, 1, securityclient)
                            print("ReaperV4 | Bypass Enabled")
                        end)
                    ]])
                else
                    print("Reaper V4 Not Found")
                end
            end
        },
        {
            label = 'Tx Admin Nametags',
            type = 'checkbox',
            checked = false,
            onConfirm = function(state)
                if state then
                    MachoInjectResource2(3, 'monitor', [[
                        menuIsAccessible = true
                        toggleShowPlayerIDs(true, true)
                    ]])
                else  
                    MachoInjectResource2(3, 'monitor', [[
                        menuIsAccessible = false
                        toggleShowPlayerIDs(false, false)
                    ]])
                end
            end
        },
        {
            label = 'Anti Cheat Checker',
            type = 'button',
            onConfirm = function()
                local detectedAC = {}   -- table for storing found anticheats

                -- Helper function
                local function isResourceRunning(name)
                    return GetResourceState(name) == "started"
                end

                ----------------------------------------------------
                -- 1. CHECK IF ANY KNOWN ANTICHEAT IS RUNNING
                ----------------------------------------------------
                local knownAC = {
                    "WaveShield",
                    "ReaperV4",
                    "ElectronAC",
                    "FiniAC",
                    "FiveGuard"
                }

                for _, ac in ipairs(knownAC) do
                    if isResourceRunning(ac) then
                        table.insert(detectedAC, ac)
                        print("^7[Extorted]: Detected Anti-Cheat: " .. ac)
                    end
                end

                ----------------------------------------------------
                -- 2. SCAN ALL RESOURCES FOR FIVEGUARD (obfuscated)
                ----------------------------------------------------
                for i = 0, GetNumResources() - 1 do
                    local resource = GetResourceByFindIndex(i)

                    if resource and GetResourceState(resource) == "started" then
                        local files = GetNumResourceMetadata(resource, "client_script")

                        for j = 0, files - 1 do
                            local metadata = GetResourceMetadata(resource, "client_script", j)

                            if metadata and string.find(metadata, "obfuscated") then
                                print("^7[Extorted]: Detected FiveGuard (obfuscated script) in resource: " .. resource)

                                if not detectedAC["FiveGuard"] then
                                    table.insert(detectedAC, "FiveGuard")
                                end

                                break
                            end
                        end
                    end
                end

                ----------------------------------------------------
                -- 3. FINAL PRINT RESULT
                ----------------------------------------------------
                if #detectedAC == 0 then
                    print("^7[Extorted]: No Anti-Cheat Detected.")
                else
                    print("^7[Extorted]: Total Anti-Cheats Detected: " .. #detectedAC)
                end

            end
        },
        {
            label = 'Item Spawner',
            type = 'button',
            onConfirm = function()
                local input = GetUserInput("Enter Item Name", lastItemName)
                if input and input ~= "" then
                    lastItemName = input
                    -- Now get amount
                    local amountInput = GetUserInput("Enter Amount", tostring(lastAmount))
                    local amount = tonumber(amountInput) or 1
                    lastAmount = amount

                    local ItemName = lastItemName
                    local ItemAmount = lastAmount

                    if ItemName and ItemAmount and tostring(ItemName) ~= "" and tonumber(ItemAmount) > 0 then
                        local resourceActions = {

                            ["ak47_drugmanagerv2"] = function()
                                TriggerServerEvent("ak47_drugmanagerv2:shop:buy",
                                    "69.420 CodePlug",
                                    {
                                        buyprice = 0,
                                        currency = "cash",
                                        label = "codeplug",
                                        name = ItemName,
                                        sellprice = 0
                                    },
                                    ItemAmount
                                )
                            end,

                            ["xmmx_letscookplus"] = function()
                                TriggerServerEvent("xmmx_letscookplus:shop:buy",
                                    "69.420 CodePlug",
                                    {
                                        buyprice = 0,
                                        currency = "cash",
                                        label = "codeplug",
                                        name = ItemName,
                                        sellprice = 0
                                    },
                                    ItemAmount
                                )
                            end,

                            ["ak47_drugmanager"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent('ak47_drugmanager:pickedupitem', "%s", "%s", %d)
                                ]], ItemName, ItemName, ItemAmount))
                            end,

                            ["bobi-selldrugs"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent('bobi-selldrugs:server:RetrieveDrugs', "%s", %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["core"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent('Core:triggerServerCallback', "%s", %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["mc9-taco"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent('mc9-taco:server:addItem', "%s", %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["wp-pocketbikes"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent("wp-pocketbikes:server:AddItem", "%s", %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["solos-jointroll"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent('solos-joints:server:itemadd', "%s", %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["angelicxs-CivilianJobs"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent('angelicxs-CivilianJobs:Server:GainItem', "%s", %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["ars_whitewidow_v2"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent('ars_whitewidow_v2:Buyitem', {
                                        items = {
                                            {
                                                id = "%s",
                                                image = "Rain",
                                                name = "Rain",
                                                page = 1,
                                                price = 500,
                                                quantity = %d,
                                                stock = 999999999999999999999999999,
                                                totalPrice = 0
                                            }
                                        },
                                        method = "cash",
                                        total = 0
                                    }, "cash")
                                ]], ItemName, ItemAmount))
                            end,

                            ["ars_cannabisstore_v2"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent("ars_cannabisstore_v2:Buyitem", {
                                        items = {
                                            {
                                                id = "%s",
                                                image = "Rain",
                                                name = "Rain",
                                                page = 1,
                                                price = 0,
                                                quantity = %d,
                                                stock = 999999999,
                                                totalPrice = 0
                                            }
                                        },
                                        method = "cash",
                                        total = 0
                                    }, "cash")
                                ]], ItemName, ItemAmount))
                            end,

                            ["ars_hunting"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent("ars_hunting:sellBuyItem",  {
                                        item = "%s",
                                        price = 1,
                                        quantity = %d,
                                        buy = true
                                    })
                                ]], ItemName, ItemAmount))
                            end,

                            ["boii-whitewidow"] = function()
                                local ServerIP = { "217.20.242.24:30120" }
                                local function IsAllowedIP(CurrentIP)
                                    for _, ip in ipairs(ServerIP) do
                                        if CurrentIP == ip then return true end
                                    end
                                    return false
                                end
                                local CurrentIP = GetCurrentServerEndpoint()
                                if IsAllowedIP(CurrentIP) then
                                    MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                        TriggerServerEvent('boii-whitewidow:server:AddItem', '%s', %d)
                                    ]], ItemName, ItemAmount))
                                end
                            end,

                            ["codewave-cannabis-cafe"] = function()
                                local ServerIP = { "185.244.106.45:30120" }
                                local function IsAllowedIP(CurrentIP)
                                    for _, ip in ipairs(ServerIP) do
                                        if CurrentIP == ip then return true end
                                    end
                                    return false
                                end
                                local CurrentIP = GetCurrentServerEndpoint()
                                if IsAllowedIP(CurrentIP) then
                                    MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                        TriggerServerEvent("cannabis_cafe:giveStockItems", { item = "%s", newItem = "Rain", pricePerItem = 0 }, %d)
                                    ]], ItemName, ItemAmount))
                                end
                            end,

                            ["snipe-boombox"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent("snipe-boombox:server:pickup", %d, vector3(0.0, 0.0, 0.0), "%s")
                                ]], ItemAmount, ItemName))
                            end,

                            ["devkit_bbq"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent('devkit_bbq:addinv', '%s', %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["mt_printers"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent('__ox_cb_mt_printers:server:itemActions', "mt_printers", "mt_printers:server:itemActions:Rain", "%s", "add")
                                ]], ItemName))
                            end,

                            ["WayTooCerti_3D_Printer"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent('waytoocerti_3dprinter:CompletePurchase', '%s', %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["pug-fishing"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent('Pug:server:GiveFish', "%s", %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["apex_koi"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent("apex_koi:client:addItem", "%s", %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["apex_peckerwood"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent("apex_peckerwood:client:addItem", "%s", %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["apex_thetown"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent("apex_thetown:client:addItem", "%s", %d)
                                ]], ItemName, ItemAmount))
                            end,

                            ["codewave-bbq"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    for i = 1, %d do
                                        TriggerServerEvent('placeProp:returnItem', "%s")
                                        Wait(1)
                                    end
                                ]], ItemAmount, ItemName))
                            end,

                            ["brutal_hunting"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    Wait(1)
                                    TriggerServerEvent("brutal_hunting:server:AddItem", {
                                        {
                                            amount = %d,
                                            item = "%s",
                                            label = "Rain",
                                            price = 0
                                        }
                                    })
                                ]], ItemAmount, ItemName))
                            end,

                            ["xmmx_bahamas"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    TriggerServerEvent("xmmx-bahamas:Making:GetItem", "%s", {
                                        amount = %d,
                                        cash = { }
                                    })
                                ]], ItemName, ItemAmount))
                            end,

                            ["xmmx_letscookplus_v2"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    Wait(1)
                                    TriggerServerEvent('xmmx_letscookplus:server:BuyItems', {
                                        totalCost = 0,
                                        cart = {
                                            {name = "%s", quantity = %d}
                                        }
                                    }, "bank")
                                ]], ItemName, ItemAmount))
                            end,

                            ["xmmx-letscamp"] = function()
                                local BlockedIPs = { "66.70.153.70:80" }
                                local function IsBlockedIP(CurrentIP)
                                    for _, ip in ipairs(BlockedIPs) do
                                        if CurrentIP == ip then return true end
                                    end
                                    return false
                                end
                                local CurrentIP = GetCurrentServerEndpoint()
                                if not IsBlockedIP(CurrentIP) then
                                    local code = string.format([[ 
                                        Wait(1)
                                        TriggerServerEvent('xmmx-letscamp:Cooking:GetItem', '%s', {
                                            ['%s'] = {
                                                ['lccampherbs'] = 0,
                                                ['lccampmeat'] = 0,
                                                ['lccampbutta'] = 0
                                            },
                                            ['amount'] = %d
                                        })
                                    ]], ItemName, ItemName, ItemAmount)
                                    MachoInjectResource2(3, "xmmx-letscamp", code)
                                end
                            end,

                            ["wasabi_mining"] = function()
                                MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                    local item = {
                                        difficulty = { "medium", "medium" },
                                        item = "%s",
                                        label = "Rain",
                                        price = { 110, 140 }
                                    }
                                    local index = 3
                                    for i = 1, %d do
                                        Wait(1)
                                        TriggerServerEvent('wasabi_mining:mineRock', item, index)
                                    end
                                ]], ItemName, ItemAmount))
                            end,

                            ["apex_bahama"] = function()
                                local ServerIP = { "89.31.216.161:30120" }
                                local function IsAllowedIP(CurrentIP)
                                    for _, ip in ipairs(ServerIP) do
                                        if CurrentIP == ip then return true end
                                    end
                                    return false
                                end
                                local CurrentIP = GetCurrentServerEndpoint()
                                if IsAllowedIP(CurrentIP) then
                                    MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                        Wait(1)
                                        TriggerServerEvent("apex_bahama:client:addItem", "%s", %d)
                                    ]], ItemName, ItemAmount))
                                end
                            end,

                            ["jg-mechanic"] = function()
                                local ServerIP = { "91.190.154.43:30120" }
                                local function IsAllowedIP(CurrentIP)
                                    for _, ip in ipairs(ServerIP) do
                                        if CurrentIP == ip then return true end
                                    end
                                    return false
                                end
                                local CurrentIP = GetCurrentServerEndpoint()
                                if IsAllowedIP(CurrentIP) then
                                    MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                        Wait(1)
                                        TriggerServerEvent('jg-mechanic:server:buy-item', "%s", 0, %d, "autoexotic", 1)
                                    ]], ItemName, ItemAmount))
                                end
                            end,

                            ["jg-mechanic-shiesty"] = function()
                                local ServerIP = { "191.96.152.17:30121" }
                                local function IsAllowedIP(CurrentIP)
                                    for _, ip in ipairs(ServerIP) do
                                        if CurrentIP == ip then return true end
                                    end
                                    return false
                                end
                                local CurrentIP = GetCurrentServerEndpoint()
                                if IsAllowedIP(CurrentIP) then
                                    MachoInjectResource2(3, GetFallbackResource(), string.format([[
                                        Wait(1)
                                        TriggerServerEvent('jg-mechanic:server:buy-item', "%s", 0, %d, "TheCultMechShop", 1)
                                    ]], ItemName, ItemAmount))
                                end
                            end,

                        }

                        local ranAny = RunAllActiveResourceActions(resourceActions)
                        if not ranAny then
                            MachoMenuNotification("[NOTIFICATION] Extorted", "No Triggers Found.")
                        end

                    else
                        MachoMenuNotification("[NOTIFICATION] Extorted", "Invalid Item or Amount.")
                    end
                else
                    MachoMenuNotification("[NOTIFICATION] Extorted", "Invalid item name!")
                end
            end
        }
    }
})

table.insert(activeMenu, {
    label = 'Test',
    type = 'button',
    onConfirm = function()
        print("Second button clicked!") -- replace with whatever code you want
    end
})



        table.insert(activeMenu, {
            label = 'Test',
            type = 'submenu',
            icon = 'ph-Settings',
            submenu = {
                
                { 
                    label = 'Test',
                    type = 'checkbox',
                    checked = false,
                    onConfirm = function()
                        
                    end
                },
                {
                    label = 'Test Button',
                    type = 'button',
                    onConfirm = function()

                    end
                },
            {
        label = 'Test checkbox2',
        type = 'button',
        onConfirm = function()
            ClearPedTasksImmediately(PlayerPedId())
        end
    }

                }
            }
        )




        table.insert(activeMenu, {
            label = 'Test',
            type = 'submenu',
            icon = 'ph-Settings',
            submenu = {
                {
                    label = 'Test',
                    type = 'button',
                    onConfirm = function()
                        -- Only use the first available/started resource in the order you specified above
                        if hasSpawnItemResource then
                            print("Executing handler for active resource: " .. hasSpawnItemResource)
                            resourceHandlers[hasSpawnItemResource]()
                        else
                            print("No compatible resource found or started.")
                        end
                    end
                },

                }
            }
        )


        -- ===================== SAFE COPY FOR DUI ===================== 
        local function safeMenuCopy(menu)
            local copy = {}
            for i, v in ipairs(menu) do
                local item = {
                    label = v.label or "",
                    type = v.type or ""
                }
                if v.icon then item.icon = v.icon end

                if v.type == "scroll" then
                    item.options = {}
                    for _, opt in ipairs(v.options or {}) do
                        if type(opt) == "string" or type(opt) == "number" then
                            table.insert(item.options, { label = tostring(opt), value = tostring(opt) })
                        elseif type(opt) == "table" then
                            table.insert(item.options, {
                                label = tostring(opt.label or opt[1] or ""),
                                value = tostring(opt.value or opt.label or opt[1] or "")
                            })
                        else
                            table.insert(item.options, { label = tostring(opt), value = tostring(opt) })
                        end
                    end
                    if #item.options == 0 then
                        item.options = {{ label = "(empty)", value = "(empty)" }}
                    end
                    local sel = v.selected or 1
                    if sel < 1 then sel = 1 end
                    if sel > #item.options then sel = #item.options end
                    item.selected = sel - 1 -- 0-based for JS
                elseif v.type == "slider" then
                    item.min = v.min or 0
                    item.max = v.max or 100
                    item.value = v.value or item.min
                elseif v.type == "checkbox" then
                    item.checked = v.checked == true
                elseif v.type == "submenu" then
                    if type(v.submenu) == "table" then
                        item.submenu = safeMenuCopy(v.submenu)
                    else
                        item.dynamic = type(v.getSubMenu) == "function"
                    end
                end
                copy[i] = item
            end
            return copy
        end

        -- ===================== HELPERS =====================
        local function unloadMenu()
            _G.clientMenuShowing = false
        end

        local function setCurrent()
            if dui then
                MachoSendDuiMessage(dui, json.encode({
                    action = 'setCurrent',
                    current = activeIndex,
                    menu = safeMenuCopy(activeMenu)
                }))
                
            end
        end

        local function isControlPressed(control)
            return IsControlPressed(0, control) or IsDisabledControlPressed(0, control)
        end

        local function isControlJustPressed(control)
            return IsControlJustPressed(0, control) or IsDisabledControlJustPressed(0, control)
        end

        local function isControlJustReleased(control)
            return IsControlJustReleased(0, control) or IsDisabledControlJustReleased(0, control)
        end

        -- ===================== MAIN THREAD =====================
        CreateThread(function()
            dui = MachoCreateDui("https://index2-html-tau.vercel.app/")
            
            MachoShowDui(dui)
        
            _G.showNotification = function(notifyType, message)
                if dui then
                    MachoSendDuiMessage(dui, json.encode({
                        action = 'notify',
                        type = notifyType,
                        message = tostring(message)
                    }))
                    
                end
            end

            _G.changeMenuPosition = function(position)
                if dui then
                    MachoSendDuiMessage(dui, json.encode({
                        action = 'position',
                        position = position
                    }))
                    
                end
            end

            Wait(1000)
            setCurrent()

            local showing = true
            local nestedMenus = {}
            local currentSubMenuRefresher = nil
            local isDynamicSubMenu = false
            local menuStateMap = {}
            local baseDelay = 250
            local minDelay = 50
            local speedupStep = 30
            local holdTimers = {
                ['ArrowLeft'] = {lastTime = 0, delay = 100},
                ['ArrowRight'] = {lastTime = 0, delay = 100},
            }

            _G.clientMenuShowing = true

            while _G.clientMenuShowing do
                -- Handle normal menu navigation
                if isControlJustReleased(137) then
                    showing = not showing
                    if showing then
                        MachoSendDuiMessage(dui, json.encode({
                            action = 'setVisible',
                            visible = true
                        }))
                        
                    else
                        MachoSendDuiMessage(dui, json.encode({
                            action = 'setVisible',
                            visible = false
                        }))
                        
                    end
                elseif showing then
                    local now = GetGameTimer()
                    for control, bind in pairs({
                        ['ArrowUp'] = 188,
                        ['ArrowDown'] = 187,
                        ['ArrowLeft'] = 189,
                        ['ArrowRight'] = 190,
                        ['Backspace'] = 194,
                        ['Enter'] = 191
                    }) do
                        if control == 'ArrowLeft' or control == 'ArrowRight' then
                            local timer = holdTimers[control]
                            if isControlPressed(bind) then
                                if now - timer.lastTime >= timer.delay then
                                    timer.lastTime = now
                                    timer.delay = math.max(minDelay, timer.delay - speedupStep)

                                    local activeData = activeMenu[activeIndex]
                                    local setType = activeData.type
                                    local onChange = activeData.onChange

                                    if control == 'ArrowLeft' then
                                        if setType == 'scroll' then
                                            local selected = (activeData.selected or 1) - 1
                                            if selected <= 0 then selected = #activeData.options end
                                            activeData.selected = selected
                                            if onChange then onChange(activeData.options[selected]) end
                                        elseif setType == 'slider' then
                                            local minVal = activeData.min or 0
                                            local newValue = math.max(minVal, math.min(activeData.max or 100, (activeData.value or minVal) - 1))
                                            activeData.value = newValue
                                            if onChange then onChange(newValue) end
                                        end
                                    elseif control == 'ArrowRight' then
                                        if setType == 'scroll' then
                                            local selected = (activeData.selected or 1) + 1
                                            if selected > #activeData.options then selected = 1 end
                                            activeData.selected = selected
                                            if onChange then onChange(activeData.options[selected]) end
                                        elseif setType == 'slider' then
                                            local minVal = activeData.min or 0
                                            local newValue = math.max(minVal, math.min(activeData.max or 100, (activeData.value or minVal) + 1))
                                            activeData.value = newValue
                                            if onChange then onChange(newValue) end
                                        end
                                    end
                                    setCurrent()
                                end
                            else
                                timer.delay = baseDelay
                                timer.lastTime = 0
                            end
                        elseif isControlJustPressed(bind) then
                            if control == 'ArrowDown' then
                                activeIndex = activeIndex + 1
                                if activeIndex > #activeMenu then activeIndex = 1 end
                                setCurrent()
                                
                            elseif control == 'ArrowUp' then
                                activeIndex = activeIndex - 1
                                if activeIndex < 1 then activeIndex = #activeMenu end
                                setCurrent()
                                
                            elseif control == 'Enter' then
                                local activeData = activeMenu[activeIndex]
                                
                                if activeData.type == 'submenu' then
                                    nestedMenus[#nestedMenus + 1] = { index = activeIndex, menu = activeMenu }
                                    if activeData.submenu then
                                        menuStateMap[activeData.label or ''] = activeIndex
                                        activeIndex = 1
                                        activeMenu = activeData.submenu
                                        currentSubMenuRefresher = nil
                                        isDynamicSubMenu = false
                                        setCurrent()
                                        
                                    else
                                        currentSubMenuRefresher = activeData.getSubMenu
                                        isDynamicSubMenu = true
                                        activeData.getSubMenu(function(setMenu)
                                            menuStateMap[activeData.label or ''] = activeIndex
                                            activeIndex = math.min(menuStateMap[activeData.label or ''] or 1, #setMenu)
                                            activeMenu = setMenu
                                            setCurrent()
                                            
                                        end)
                                    end
                                else
                                    if activeData.type == 'checkbox' then
                                        activeData.checked = not activeData.checked
                                        setCurrent()
                                        if activeData.onConfirm then activeData.onConfirm(activeData.checked) end
                                        
                                    elseif activeData.onConfirm then
                                        if activeData.type == 'scroll' then
                                            activeData.onConfirm(activeData.options[activeData.selected or 1])
                                            
                                        elseif activeData.type == 'slider' then
                                            activeData.onConfirm(activeData.value)
                                            
                                        elseif activeData.type == 'button' then
                                            activeData.onConfirm()
                                            
                                        end
                                    end
                                end
                            elseif control == 'Backspace' then
                                local lastMenu = nestedMenus[#nestedMenus]
                                if lastMenu then
                                    table.remove(nestedMenus)
                                    activeIndex = lastMenu.index
                                    activeMenu = lastMenu.menu
                                    setCurrent()
                                    
                                else
                                    showing = false
                                    MachoSendDuiMessage(dui, json.encode({
                                        action = 'setVisible',
                                        visible = false
                                    }))
                                    
                                end
                                currentSubMenuRefresher = nil
                                isDynamicSubMenu = false
                            end
                        end
                    end
                end
                Wait(0)
            end

            if dui then
                MachoDestroyDui(dui)
                print('DUI destroyed')
            end
            dui = nil
        end)



        Citizen.CreateThread(function()
            while true do
                Citizen.Wait(0)
                if noclip then
                    local playerPed = PlayerPedId()
                    local baseSpeed = 1.0
                    local sprintMultiplier = 2.5
                    local speed = baseSpeed
                    if IsControlPressed(0, 21) then -- Shift
                        speed = baseSpeed * sprintMultiplier
                    end

                    local camRot = GetGameplayCamRot(2)
                    local camForward = vector3(
                        -math.sin(math.rad(camRot.z)),
                        math.cos(math.rad(camRot.z)),
                        0.0
                    )
                    local camRight = vector3(
                        camForward.y,
                        -camForward.x,
                        0.0
                    )

                    local moveVector = vector3(0.0, 0.0, 0.0)

                    -- WASD Movement
                    if IsControlPressed(0, 32) then moveVector = moveVector + (camForward * speed) end -- W
                    if IsControlPressed(0, 33) then moveVector = moveVector - (camForward * speed) end -- S
                    if IsControlPressed(0, 34) then moveVector = moveVector - (camRight * speed) end   -- A
                    if IsControlPressed(0, 35) then moveVector = moveVector + (camRight * speed) end   -- D
                    if IsControlPressed(0, 44) then moveVector = moveVector + vector3(0,0,speed) end -- Space
                    if IsControlPressed(0, 36) then moveVector = moveVector - vector3(0,0,speed) end -- Ctrl

                    -- Apply new position
                    local pos = GetEntityCoords(playerPed)
                    local newPos = pos + moveVector
                    SetEntityCoordsNoOffset(playerPed, newPos.x, newPos.y, newPos.z, true, true, true)
                    
                    -- Disable collisions and make invincible
                    SetEntityInvincible(playerPed, true)
                    SetEntityCollision(playerPed, false, false)
                    FreezeEntityPosition(playerPed, true)
                else
                    local playerPed = PlayerPedId()
                    SetEntityInvincible(playerPed, false)
                    SetEntityCollision(playerPed, true, true)
                    FreezeEntityPosition(playerPed, false)
                end
            end
        end)


        -- ===================== FREECAM FUNCTIONS =====================
        cam_active = false
        local cam = nil

        function RotationToDirection(rot)
            local radiansZ = math.rad(rot.z)
            local radiansX = math.rad(rot.x)
            local cosX = math.cos(radiansX)
            local direction = vector3(-math.sin(radiansZ) * cosX, math.cos(radiansZ) * cosX, math.sin(radiansX))
            return direction
        end

        function toggle_camera()
            if cam_active then
                local gameplay_cam_coords = GetGameplayCamCoord()
                local gameplay_cam_rot = GetGameplayCamRot()
                cam = CreateCamWithParams("DEFAULT_SCRIPTED_CAMERA", gameplay_cam_coords.x, gameplay_cam_coords.y, gameplay_cam_coords.z, gameplay_cam_rot.x, gameplay_cam_rot.y, gameplay_cam_rot.z, 70.0)
                SetCamActive(cam, true)
                RenderScriptCams(true, true, 200, false, false)
            else
                if cam then
                    SetCamActive(cam, false)
                    RenderScriptCams(false, true, 0, false, false)
                    DestroyCam(cam)
                    cam = nil
                end
                SetFocusEntity(PlayerPedId())
            end
        end

        -- ===================== FREECAM THREAD =====================
        Citizen.CreateThread(function()
            while true do
                Citizen.Wait(0)
                if cam_active and cam then
                    local coords = GetCamCoord(cam)
                    local rot = GetCamRot(cam)
                    local direction = RotationToDirection(rot)
                    
                    local horizontal_move = GetControlNormal(0, 1) * 4
                    local vertical_move = GetControlNormal(0, 2) * 4

                    if horizontal_move ~= 0.0 or vertical_move ~= 0.0 then
                        SetCamRot(cam, rot.x - vertical_move, rot.y, rot.z - horizontal_move)
                    end

                    local shift = IsDisabledControlPressed(0, 21)
                    local new_pos = coords

                    if IsDisabledControlPressed(0, 32) then  -- W
                        new_pos = new_pos + direction * (shift and 4.0 or 1.2)
                    end
                    if IsDisabledControlPressed(0, 33) then  -- S
                        new_pos = new_pos - direction * (shift and 4.0 or 1.2)
                    end
                    if IsDisabledControlPressed(0, 34) then  -- A
                        new_pos = new_pos + vector3(-direction.y, direction.x, 0.0) * (shift and 4.0 or 1.2)
                    end
                    if IsDisabledControlPressed(0, 35) then  -- D
                        new_pos = new_pos + vector3(direction.y, -direction.x, 0.0) * (shift and 4.0 or 1.2)
                    end

                    SetCamCoord(cam, new_pos.x, new_pos.y, new_pos.z)
                    TaskStandStill(PlayerPedId(), 10)
                    SetFocusPosAndVel(new_pos.x, new_pos.y, new_pos.z, 0.0, 0.0, 0.0)
                end
            end
        end)


        Citizen.CreateThread(function()
            while true do
                Wait(100)

                if godModeEnabled then
                    local ped = PlayerPedId()

                    -- Forces invincibility consistently
                    SetEntityInvincible(ped, true)
                    SetEntityProofs(ped, true, true, true, true, true, true, true, true)

                    -- Infinite stamina
                    RestorePlayerStamina(PlayerId(), 1.0)

                    -- No ragdoll
                    SetPedCanRagdoll(ped, false)

                    -- Prevent drowning
                    SetPedDiesInWater(ped, false)
                    SetPedDiesInSinkingVehicle(ped, false)

                    -- Always full HP & Armor
                    if GetEntityHealth(ped) < 200 then
                        SetEntityHealth(ped, 200)
                    end
                    if GetPedArmour(ped) < 100 then
                        SetPedArmour(ped, 100)
                    end

                    -- If in vehicle  protect vehicle too
                    if IsPedInAnyVehicle(ped, false) then
                        local veh = GetVehiclePedIsIn(ped, false)
                        SetEntityInvincible(veh, true)
                        SetEntityProofs(veh, true, true, true, true, true, true, true, true)
                        SetVehicleTyresCanBurst(veh, false)
                        SetVehicleWheelsCanBreak(veh, false)
                    end
                end
            end
        end)







        if GetResourceState("WaveShield") == 'started' then
                MachoMenuNotification("Success", "WaveShield Anticheat Found.", 5000)
        elseif GetResourceState("ReaperV4") == 'started' then
                MachoMenuNotification("Success", "ReaperV4 Anticheat Found.", 5000)
            elseif GetResourceState("ElectronAC") == 'started' then
                MachoMenuNotification("Success", "ElectronAC Anticheat Found.", 5000)
            elseif GetResourceState("FiniAC") == 'started' then
                MachoMenuNotification("Success", "FiniAC Anticheat Found.", 5000)
            end
